<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>WebRol IOT Controller</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
      :root {
        --primary: #4a6fa5;
        --primary-gradient: linear-gradient(135deg, #4a6fa5 0%, #6b8cc6 100%);
        --primary-light: #6b8cc6;
        --primary-dark: #3a5a84;
        --off-state: #ff4757;
        --on-state: #2ed573;
        --bg: #f8f9fa;
        --card: #ffffff;
        --text: #2c3e50;
        --text-light: #7f8c8d;
        --border: #e1e4e8;
        --shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        --base-font-size: 16px;
        --transition: all 0.3s ease;
        --input-bg: white;
        --input-text: #333333;
        --input-border: #e1e4e8;
        --device-text: #3a5a84; /* Warna teks khusus untuk perangkat */
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Segoe UI', 'Poppins', Roboto, -apple-system, BlinkMacSystemFont, sans-serif;
        max-width: 480px;
        margin: 0 auto;
        padding: 20px;
        background-color: var(--bg);
        color: var(--text);
        font-size: var(--base-font-size);
        line-height: 1.6;
        transition: var(--transition);
      }

      .card {
        background: var(--card);
        border-radius: 20px;
        padding: 1.8rem;
        box-shadow: var(--shadow);
        transition: var(--transition);
      }

      .card:hover {
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
      }

      .header {
        text-align: center;
        margin-bottom: 1.8rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid var(--border);
        position: relative;
      }

      .header::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 60px;
        height: 4px;
        background: var(--primary-gradient);
        border-radius: 2px;
      }

      h1 {
        color: var(--primary);
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .subtitle {
        font-size: 1rem;
        color: var(--text-light);
        font-weight: 400;
      }

      .devices-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .device-card {
        background: #f8faff;
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 1.2rem;
        text-align: center;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        transition: var(--transition);
        position: relative;
        overflow: hidden;
      }

      .device-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
      }

      .device-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: var(--primary-gradient);
        opacity: 0.7;
      }

      .device-name {
        margin-bottom: 1rem;
        font-weight: 600;
        color: var(--device-text);
        font-size: 1.05rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        transition: var(--transition);
      }

      .device-icon {
        font-size: 1.2rem;
      }

      .toggle-btn {
        padding: 0.85rem 1.2rem;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        font-size: 0.95rem;
        font-weight: 600;
        width: 100%;
        transition: var(--transition);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        position: relative;
        overflow: hidden;
      }

      .toggle-btn::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.1);
        transform: translateX(-100%);
        transition: transform 0.3s ease;
      }

      .toggle-btn:hover::after {
        transform: translateX(0);
      }

      .toggle-btn:active {
        transform: scale(0.98);
      }

      .on {
        background: var(--on-state);
        color: white;
        box-shadow: 0 4px 14px rgba(46, 213, 115, 0.4);
      }

      .off {
        background: var(--off-state);
        color: white;
        box-shadow: 0 4px 14px rgba(255, 71, 87, 0.4);
      }

      .log-container {
        margin-top: 2rem;
        transition: var(--transition);
      }

      .log-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.8rem;
      }

      .log-title {
        font-weight: 600;
        font-size: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .clear-log {
        background: none;
        border: none;
        color: var(--primary);
        font-size: 0.9rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.3rem;
        padding: 0.4rem 0.6rem;
        border-radius: 6px;
        transition: var(--transition);
      }

      .clear-log:hover {
        background: rgba(74, 111, 165, 0.1);
      }

      #log {
        border: 1px solid var(--border);
        padding: 1.2rem;
        height: 180px;
        overflow-y: auto;
        border-radius: 14px;
        font-size: 0.9rem;
        background: #fafafa;
        scroll-behavior: smooth;
        transition: var(--transition);
      }

      #log::-webkit-scrollbar {
        width: 6px;
      }

      #log::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
      }

      #log::-webkit-scrollbar-thumb {
        background: var(--primary-light);
        border-radius: 10px;
      }

      #log::-webkit-scrollbar-thumb:hover {
        background: var(--primary);
      }

      .log-entry {
        margin-bottom: 0.8rem;
        padding-bottom: 0.8rem;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(5px); }
        to { opacity: 1; transform: translateY(0); }
      }

      .log-time {
        color: var(--text-light);
        font-size: 0.8rem;
        margin-right: 0.8rem;
        flex-shrink: 0;
        width: 55px;
        font-weight: 500;
      }

      .log-message {
        color: var(--text);
        flex: 1;
        word-break: break-word;
      }

      .schedule-card,
      .current-schedule {
        background: #f8faff;
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border: 1px solid var(--border);
        transition: var(--transition);
      }

      .schedule-card:hover,
      .current-schedule:hover {
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
      }

      .schedule-title,
      .current-schedule-title {
        font-weight: 700;
        margin-bottom: 1.2rem;
        color: var(--primary);
        text-align: center;
        font-size: 1.2rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
      }

      .time-input-group {
        display: flex;
        align-items: center;
        margin-bottom: 1rem;
        background: white;
        padding: 0.8rem 1rem;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        transition: var(--transition);
      }

      .time-input-group label {
        width: 100px;
        font-weight: 500;
        color: var(--text);
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      input[type="time"] {
        flex: 1;
        padding: 0.7rem 1rem;
        border: 1px solid var(--input-border);
        border-radius: 10px;
        font-size: 1rem;
        background: var(--input-bg);
        color: var(--input-text);
        font-family: inherit;
        transition: var(--transition);
      }

      input[type="time"]:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(74, 111, 165, 0.2);
      }

      .schedule-info {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
        margin-bottom: 1rem;
      }

      .schedule-item {
        text-align: center;
        background: white;
        padding: 1rem;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        transition: var(--transition);
      }

      .schedule-item:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        background: #f8f9ff;
      }

      .schedule-label {
        font-size: 0.9rem;
        color: var(--text-light);
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.4rem;
      }

      .schedule-time {
        font-weight: 700;
        font-size: 1.2rem;
        color: var(--primary);
      }

      .status-badge {
        display: inline-block;
        padding: 0.3rem 0.8rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
      }

      .status-active {
        background: rgba(46, 213, 115, 0.2);
        color: var(--on-state);
      }

      .status-inactive {
        background: rgba(255, 71, 87, 0.2);
        color: var(--off-state);
      }

      .status-auto {
        background: rgba(74, 111, 165, 0.2);
        color: var(--primary);
      }

      .status-manual {
        background: rgba(255, 165, 0, 0.2);
        color: #ff9f43;
      }

      /* Animasi untuk toggle button */
      @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
      }

      .toggle-btn.pulse {
        animation: pulse 0.5s ease;
      }

      /* Mode gelap */
      .dark-mode-toggle {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: var(--primary-light);
        color: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        transition: var(--transition);
        z-index: 10;
      }

      .dark-mode-toggle:hover {
        transform: rotate(30deg);
      }

      /* Dark mode styles */
      body.dark-mode {
        --bg: #1a1a2e;
        --card: #16213e;
        --text: #ffffff;
        --text-light: #b0b0b0;
        --border: #2d4059;
        --input-bg: #2d4059;
        --input-text: #ffffff;
        --input-border: #4a6fa5;
        --device-text: #ffffff; /* Teks perangkat menjadi putih di mode gelap */
      }

      body.dark-mode .device-card,
      body.dark-mode .schedule-card,
      body.dark-mode .current-schedule,
      body.dark-mode .time-input-group {
        background: rgba(255, 255, 255, 0.05);
      }

      body.dark-mode .schedule-item {
        background: rgba(255, 255, 255, 0.08);
      }

      body.dark-mode .schedule-item:hover {
        background: rgba(255, 255, 255, 0.12);
      }

      body.dark-mode #log {
        background: #1a1a2e;
        border-color: #2d4059;
      }

      body.dark-mode .log-entry {
        border-bottom-color: #2d4059;
      }

      body.dark-mode input[type="time"]::-webkit-calendar-picker-indicator {
        filter: invert(1);
      }

      /* Media Queries untuk Responsivitas */
      @media (max-width: 480px) {
        :root {
          --base-font-size: 15px;
        }
        
        body {
          padding: 1rem;
        }

        .card {
          padding: 1.5rem;
          border-radius: 18px;
        }

        .devices-grid {
          grid-template-columns: repeat(2, 1fr);
          gap: 1.2rem;
        }

        .device-card {
          padding: 1rem;
        }

        .toggle-btn {
          padding: 0.75rem 1rem;
          font-size: 0.9rem;
        }

        .time-input-group {
          flex-direction: row;
          align-items: center;
          padding: 0.7rem 0.9rem;
        }

        .time-input-group label {
          margin-bottom: 0;
          margin-right: 0.5rem;
          width: auto;
          min-width: 70px;
        }

        .schedule-info {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 360px) {
        .toggle-btn {
          padding: 0.7rem 0.9rem;
          font-size: 0.85rem;
        }

        .schedule-title, 
        .current-schedule-title {
          font-size: 1.1rem;
        }
      }

      /* Efek loading */
      .loading {
        position: relative;
        overflow: hidden;
      }

      .loading::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
        animation: loading 1.5s infinite;
      }

      @keyframes loading {
        100% {
          left: 100%;
        }
      }
    </style>
  </head>
  <body>
    <button class="dark-mode-toggle" id="darkModeToggle">
      <i class="fas fa-moon"></i>
    </button>

    <div class="card">
      <div class="header">
        <h1><i class="fas fa-microchip"></i> WebRol IOT Controller</h1>
        <p class="subtitle">Kontrol dan Jadwal Semua Perangkat</p>
      </div>

      <div class="devices-grid" id="deviceGrid"></div>

      <!-- Global Scheduler -->
      <div class="schedule-card">
        <div class="schedule-title"><i class="fas fa-clock"></i> Jadwal Global</div>
        <div class="time-input-group">
          <label for="global-on-time"><i class="fas fa-power-off"></i> Menyala :</label>
          <input type="time" id="global-on-time" />
        </div>
        <div class="time-input-group">
          <label for="global-off-time"><i class="fas fa-power-off"></i> Mati :</label>
          <input type="time" id="global-off-time" />
        </div>
        <button class="toggle-btn on" onclick="simpanJadwal()">
          <i class="fas fa-save"></i> Simpan Jadwal
        </button>
      </div>

      <div class="current-schedule">
        <div class="current-schedule-title"><i class="fas fa-calendar-alt"></i> Jadwal Saat Ini</div>
        <div class="schedule-info">
          <div class="schedule-item">
            <div class="schedule-label"><i class="fas fa-play-circle"></i> Menyala</div>
            <div class="schedule-time" id="current-on-time">--:--</div>
          </div>
          <div class="schedule-item">
            <div class="schedule-label"><i class="fas fa-stop-circle"></i> Mati</div>
            <div class="schedule-time" id="current-off-time">--:--</div>
          </div>
        </div>
        <div class="schedule-item">
          <div class="schedule-label"><i class="fas fa-info-circle"></i> Status</div>
          <div class="schedule-time"><span class="status-badge status-inactive" id="schedule-status">Tidak aktif</span></div>
        </div>
        <div class="schedule-item">
          <div class="schedule-label"><i class="fas fa-cog"></i> Mode</div>
          <div class="schedule-time"><span class="status-badge status-auto" id="control-mode">Otomatis</span></div>
        </div>
      </div>

      <!-- Log -->
      <div class="log-container">
        <div class="log-header">
          <div class="log-title"><i class="fas fa-history"></i> Log Aktivitas</div>
          <button class="clear-log" onclick="clearLog()">
            <i class="fas fa-broom"></i> Bersihkan
          </button>
        </div>
        <div id="log"></div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/mqtt@4.3.7/dist/mqtt.min.js"></script>
    <script>
      const broker = "wss://broker.hivemq.com:8884/mqtt";
      const client = mqtt.connect(broker, {
        clientId: "web_" + Math.random().toString(16).substr(2, 8),
        reconnectPeriod: 5000,
      });

      const devices = [
        { topicCtrl: "coba/lampu1", name: "Lampu 1", state: false, icon: "lightbulb" },
        { topicCtrl: "coba/lampu2", name: "Lampu 2", state: false, icon: "lightbulb" },
        { topicCtrl: "coba/lampu3", name: "Lampu 3", state: false, icon: "lightbulb" },
        { topicCtrl: "coba/lampu4", name: "Lampu 4", state: false, icon: "lightbulb" },
      ];

      // Topik untuk menyebarkan jadwal global
      const scheduleTopic = "coba/jadwal/global";

      const grid = document.getElementById("deviceGrid");
      const logEl = document.getElementById("log");
      const currentOnTime = document.getElementById("current-on-time");
      const currentOffTime = document.getElementById("current-off-time");
      const scheduleStatus = document.getElementById("schedule-status");
      const controlMode = document.getElementById("control-mode");
      let jadwalGlobal = { on: null, off: null };

      // Fungsi untuk menambahkan efek animasi pada tombol
      function addButtonEffect(button) {
        button.classList.add('pulse');
        setTimeout(() => {
          button.classList.remove('pulse');
        }, 500);
      }

      function addLogEntry(msg) {
        const entry = document.createElement("div");
        entry.className = "log-entry";

        const time = document.createElement("span");
        time.className = "log-time";
        time.textContent = new Date().toLocaleTimeString();

        const message = document.createElement("span");
        message.className = "log-message";
        message.textContent = msg;

        entry.appendChild(time);
        entry.appendChild(message);
        logEl.appendChild(entry);

        if (logEl.children.length > 50) {
          logEl.removeChild(logEl.firstChild);
        }

        logEl.scrollTop = logEl.scrollHeight;
      }

      function clearLog() {
        logEl.innerHTML = '';
        addLogEntry('Log dibersihkan');
      }

      function renderDevices() {
        grid.innerHTML = "";
        devices.forEach((device, index) => {
          const card = document.createElement("div");
          card.className = "device-card";

          const name = document.createElement("div");
          name.className = "device-name";
          name.innerHTML = `<i class="fas fa-${device.icon} device-icon"></i> ${device.name}`;

          const btn = document.createElement("button");
          btn.className = `toggle-btn ${device.state ? "off" : "on"}`;
          btn.innerHTML = device.state ? 
            `<i class="fas fa-toggle-on"></i> Matikan` : 
            `<i class="fas fa-toggle-off"></i> Nyalakan`;
          
          btn.onclick = () => {
            const newState = !device.state;
            addButtonEffect(btn);
            toggleDevice(index, newState, true);
          };

          card.appendChild(name);
          card.appendChild(btn);
          grid.appendChild(card);
        });
      }

      let manualOverride = false;
      let overrideTimeout = null;

      function toggleDevice(index, state, isManual = false) {
        if (isManual) {
          manualOverride = true;
          updateControlMode();

          if (overrideTimeout) clearTimeout(overrideTimeout);

          overrideTimeout = setTimeout(() => {
            manualOverride = false;
            updateControlMode();
            addLogEntry("🔁 Kembali ke mode otomatis (jadwal)");
          }, 5 * 60 * 1000);
        }

        const device = devices[index];
        client.publish(device.topicCtrl, state ? "1" : "0", { retain: true });

        if (isManual) {
          addLogEntry(
            `🖐️ ${device.name} ${state ? "dinyalakan" : "dimatikan"} secara manual`
          );
        }
      }

      function updateControlMode() {
        if (manualOverride) {
          controlMode.textContent = "Manual";
          controlMode.className = "status-badge status-manual";
        } else {
          controlMode.textContent = "Otomatis";
          controlMode.className = "status-badge status-auto";
        }
      }

      function updateScheduleDisplay() {
        currentOnTime.textContent = jadwalGlobal.on || "--:--";
        currentOffTime.textContent = jadwalGlobal.off || "--:--";
        if (jadwalGlobal.on && jadwalGlobal.off) {
          scheduleStatus.textContent = "Aktif";
          scheduleStatus.className = "status-badge status-active";
        } else {
          scheduleStatus.textContent = "Tidak aktif";
          scheduleStatus.className = "status-badge status-inactive";
        }
      }

      function simpanJadwal() {
        const onTime = document.getElementById("global-on-time").value;
        const offTime = document.getElementById("global-off-time").value;

        if (!onTime || !offTime) {
          addLogEntry("❌ Waktu ON dan OFF wajib diisi!");
          return;
        }

        jadwalGlobal = { on: onTime, off: offTime };
        updateScheduleDisplay();

        // Simpan jadwal ke localStorage
        localStorage.setItem("jadwalGlobal", JSON.stringify(jadwalGlobal));

        // Kirim jadwal ke broker MQTT (dengan retain agar klien baru langsung mendapatkannya)
        client.publish(scheduleTopic, JSON.stringify(jadwalGlobal), {
          retain: true,
        });

        addLogEntry(`✅ Jadwal disimpan: Hidup ${onTime}, Mati ${offTime}`);
      }

      // MQTT Events
      client.on("connect", () => {
        addLogEntry("✅ Terhubung ke broker MQTT");

        // Subscribe semua topik kontrol lampu
        devices.forEach((device) => {
          client.subscribe(device.topicCtrl);
        });

        // Subscribe ke topik jadwal global
        client.subscribe(scheduleTopic);
        addLogEntry(
          `🔔 Mendengarkan pembaruan jadwal di topik: ${scheduleTopic}`
        );

        // Minta jadwal terbaru (jika ada) dengan mengirim pesan kosong
        client.publish(scheduleTopic + "/get", "");
      });

      client.on("error", (err) => {
        addLogEntry(`❌ Koneksi error: ${err.message}`);
      });

      client.on("message", (topic, message) => {
        const payload = message.toString();

        // Handle pesan untuk perangkat
        if (devices.some((d) => d.topicCtrl === topic)) {
          const index = devices.findIndex((d) => d.topicCtrl === topic);
          if (index !== -1) {
            const newState = payload === "1";
            if (devices[index].state !== newState) {
              devices[index].state = newState;
              renderDevices();
              addLogEntry(
                `${devices[index].name} ${
                  newState ? "Dinyalakan" : "Dimatikan"
                } (Sinkronisasi)`
              );
            }
          }
        }

        // Handle pesan untuk jadwal global
        if (topic === scheduleTopic) {
          try {
            const newSchedule = JSON.parse(payload);
            if (newSchedule.on && newSchedule.off) {
              jadwalGlobal = newSchedule;

              // Update UI
              document.getElementById("global-on-time").value = jadwalGlobal.on;
              document.getElementById("global-off-time").value =
                jadwalGlobal.off;
              updateScheduleDisplay();

              // Simpan ke localStorage
              localStorage.setItem(
                "jadwalGlobal",
                JSON.stringify(jadwalGlobal)
              );

              addLogEntry("📅 Jadwal global diperbarui dari broker");
            }
          } catch (e) {
            addLogEntry("❌ Error parsing jadwal dari broker");
          }
        }
      });

      // Mode gelap
      const darkModeToggle = document.getElementById('darkModeToggle');
      
      // Default mode adalah terang, tidak perlu cek preferensi sistem
      const savedDarkMode = localStorage.getItem('darkMode') === 'true';
      
      // Terapkan mode gelap hanya jika sebelumnya pengguna memilihnya
      if (savedDarkMode) {
        enableDarkMode();
      }

      darkModeToggle.addEventListener('click', () => {
        if (document.body.classList.contains('dark-mode')) {
          disableDarkMode();
        } else {
          enableDarkMode();
        }
      });

      function enableDarkMode() {
        document.body.classList.add('dark-mode');
        const icon = darkModeToggle.querySelector('i');
        icon.className = 'fas fa-sun';
        
        localStorage.setItem('darkMode', 'true');
        addLogEntry('🌙 Mode gelap diaktifkan');
      }

      function disableDarkMode() {
        document.body.classList.remove('dark-mode');
        const icon = darkModeToggle.querySelector('i');
        icon.className = 'fas fa-moon';
        
        localStorage.setItem('darkMode', 'false');
        addLogEntry('☀️ Mode terang diaktifkan');
      }

      // Cek jadwal di localStorage saat pertama kali load
      window.addEventListener("load", function () {
        const savedSchedule = localStorage.getItem("jadwalGlobal");
        if (savedSchedule) {
          try {
            jadwalGlobal = JSON.parse(savedSchedule);
            document.getElementById("global-on-time").value = jadwalGlobal.on;
            document.getElementById("global-off-time").value = jadwalGlobal.off;
            updateScheduleDisplay();
            addLogEntry("📅 Jadwal dimuat dari penyimpanan lokal");
          } catch (e) {
            addLogEntry("❌ Gagal memuat jadwal dari penyimpanan lokal");
          }
        }
        
        // Animasi loading awal
        document.querySelectorAll('.device-card, .schedule-card, .current-schedule').forEach(el => {
          el.classList.add('loading');
        });
        
        setTimeout(() => {
          document.querySelectorAll('.loading').forEach(el => {
            el.classList.remove('loading');
          });
          
          // Inisialisasi tampilan
          renderDevices();
          updateScheduleDisplay();
          addLogEntry("🔄 Sistem siap digunakan");
        }, 1500);
      });

      setInterval(() => {
        if (!jadwalGlobal.on || !jadwalGlobal.off || manualOverride) return;

        const now = new Date();
        const jamMenit = now.toTimeString().substr(0, 5);

        if (jamMenit === jadwalGlobal.on) {
          devices.forEach((_, i) => toggleDevice(i, true));
          addLogEntry("⏰ Semua perangkat dinyalakan sesuai jadwal");
        }

        if (jamMenit === jadwalGlobal.off) {
          devices.forEach((_, i) => toggleDevice(i, false));
          addLogEntry("⏰ Semua perangkat dimatikan sesuai jadwal");
        }
      }, 1000);
    </script>
  </body>
</html>