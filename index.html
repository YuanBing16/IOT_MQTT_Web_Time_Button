<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebRol IOT Controller</title>
    <style>
      :root {
        --primary: #4a6fa5;
        --primary-light: #6b8cc6;
        --primary-dark: #3a5a84;
        --off-state: #e22914;
        --on-state: #1e69d3;
        --bg: #f8f9fa;
        --card: #ffffff;
        --text: #333333;
        --text-light: #777777;
        --border: #e1e4e8;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Roboto, -apple-system, BlinkMacSystemFont,
          sans-serif;
        max-width: 480px;
        margin: 0 auto;
        padding: 20px;
        background-color: var(--bg);
        color: var(--text);
      }

      .card {
        background: var(--card);
        border-radius: 16px;
        padding: 25px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15),
          0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .header {
        text-align: center;
        margin-bottom: 25px;
        padding-bottom: 20px;
        border-bottom: 1px solid var(--border);
      }

      h1 {
        color: var(--primary);
        font-size: 1.8rem;
        font-weight: 600;
      }

      .subtitle {
        font-size: 0.95rem;
        color: var(--text-light);
      }

      .devices-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .device-card {
        background: #f0f7ff;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 15px;
        text-align: center;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
      }

      .device-name {
        margin-bottom: 12px;
        font-weight: 600;
        color: var(--primary-dark);
      }

      .toggle-btn {
        padding: 10px 15px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.95rem;
        font-weight: 500;
        width: 100%;
        transition: background 0.3s ease;
      }

      .on {
        background: var(--on-state);
        color: white;
      }

      .off {
        background: var(--off-state);
        color: white;
      }

      .log-container {
        margin-top: 30px;
      }

      .log-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .log-title {
        font-weight: 600;
        font-size: 0.95rem;
      }

      .clear-log {
        background: none;
        border: none;
        color: var(--primary);
        font-size: 0.85rem;
        cursor: pointer;
        text-decoration: underline;
      }

      #log {
        border: 1px solid var(--border);
        padding: 15px;
        height: 150px;
        overflow-y: auto;
        border-radius: 10px;
        font-size: 0.85rem;
        background: #fafafa;
      }

      .log-entry {
        margin-bottom: 8px;
        padding-bottom: 8px;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
      }

      .log-time {
        color: var(--text-light);
        font-size: 0.75rem;
        margin-right: 8px;
        flex-shrink: 0;
        width: 50px;
      }

      .log-message {
        color: var(--text);
        flex: 1;
        word-break: break-word;
      }

      .schedule-card,
      .current-schedule {
        background: #f0f7ff;
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 20px;
        border: 1px solid var(--border);
      }

      .schedule-title,
      .current-schedule-title {
        font-weight: 600;
        margin-bottom: 10px;
        color: var(--primary);
        text-align: center;
      }

      .time-input-group {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
      }

      .time-input-group label {
        width: 100px;
        font-weight: 500;
        color: var(--text);
      }

      input[type="time"] {
        flex: 1;
        padding: 8px 12px;
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 1rem;
        background: white;
      }

      .schedule-info {
        display: flex;
        justify-content: space-around;
        margin-bottom: 10px;
      }

      .schedule-item {
        text-align: center;
      }

      .schedule-label {
        font-size: 0.85rem;
        color: var(--text-light);
        margin-bottom: 5px;
      }

      .schedule-time {
        font-weight: 600;
        font-size: 1.1rem;
        color: var(--primary);
      }

      @media (max-width: 480px) {
        body {
          padding: 15px;
        }

        .devices-grid {
          grid-template-columns: 1fr;
        }

        .time-input-group {
          flex-direction: column;
          align-items: flex-start;
        }

        .time-input-group label {
          margin-bottom: 5px;
        }
      }
    </style>
  </head>
  <body>
    <div class="card">
      <div class="header">
        <h1>WebRol IOT Controller</h1>
        <p class="subtitle">Kontrol dan Jadwal Semua Perangkat</p>
      </div>

      <div class="devices-grid" id="deviceGrid"></div>

      <!-- Global Scheduler -->
      <div class="schedule-card">
        <div class="schedule-title">Jadwal Global</div>
        <div class="time-input-group">
          <label for="global-on-time">Menyala :</label>
          <input type="time" id="global-on-time" />
        </div>
        <div class="time-input-group">
          <label for="global-off-time">Mati :</label>
          <input type="time" id="global-off-time" />
        </div>
        <button class="toggle-btn on" onclick="simpanJadwal()">
          Simpan Jadwal
        </button>
      </div>

      <div class="current-schedule">
        <div class="current-schedule-title">Jadwal Saat Ini</div>
        <div class="schedule-info">
          <div class="schedule-item">
            <div class="schedule-label">Menyala</div>
            <div class="schedule-time" id="current-on-time">--:--</div>
          </div>
          <div class="schedule-item">
            <div class="schedule-label">Mati</div>
            <div class="schedule-time" id="current-off-time">--:--</div>
          </div>
        </div>
        <div class="schedule-item">
          <div class="schedule-label">Status</div>
          <div class="schedule-time" id="schedule-status">Tidak aktif</div>
        </div>
        <div class="schedule-item">
          <div class="schedule-label">Mode</div>
          <div class="schedule-time" id="control-mode">Otomatis</div>
        </div>
      </div>

      <!-- Log -->
      <div class="log-container">
        <div class="log-header">
          <div class="log-title">Log Aktivitas</div>
          <button
            class="clear-log"
            onclick="document.getElementById('log').innerHTML = ''; addLogEntry('Log dibersihkan')"
          >
            Bersihkan
          </button>
        </div>
        <div id="log"></div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/mqtt@4.3.7/dist/mqtt.min.js"></script>
    <script>
      const broker = "wss://broker.hivemq.com:8884/mqtt";
      const client = mqtt.connect(broker, {
        clientId: "web_" + Math.random().toString(16).substr(2, 8),
        reconnectPeriod: 5000,
      });

      const devices = [
        { topicCtrl: "coba/lampu1", name: "Lampu 1", state: false },
        { topicCtrl: "coba/lampu2", name: "Lampu 2", state: false },
        { topicCtrl: "coba/lampu3", name: "Lampu 3", state: false },
        { topicCtrl: "coba/lampu4", name: "Lampu 4", state: false },
      ];

      // Topik untuk menyebarkan jadwal global
      const scheduleTopic = "coba/jadwal/global";

      const grid = document.getElementById("deviceGrid");
      const logEl = document.getElementById("log");
      const currentOnTime = document.getElementById("current-on-time");
      const currentOffTime = document.getElementById("current-off-time");
      const scheduleStatus = document.getElementById("schedule-status");
      let jadwalGlobal = { on: null, off: null };

      function addLogEntry(msg) {
        const entry = document.createElement("div");
        entry.className = "log-entry";

        const time = document.createElement("span");
        time.className = "log-time";
        time.textContent = new Date().toLocaleTimeString();

        const message = document.createElement("span");
        message.className = "log-message";
        message.textContent = msg;

        entry.appendChild(time);
        entry.appendChild(message);
        logEl.appendChild(entry);

        if (logEl.children.length > 50) {
          logEl.removeChild(logEl.firstChild);
        }

        logEl.scrollTop = logEl.scrollHeight;
      }

      function renderDevices() {
        grid.innerHTML = "";
        devices.forEach((device, index) => {
          const card = document.createElement("div");
          card.className = "device-card";

          const name = document.createElement("div");
          name.className = "device-name";
          name.textContent = device.name;

          const btn = document.createElement("button");
          btn.className = `toggle-btn ${device.state ? "off" : "on"}`;
          btn.textContent = device.state ? "Matikan" : "Nyalakan";
          btn.onclick = () => {
            const newState = !device.state;
            toggleDevice(index, newState, true);
          };

          card.appendChild(name);
          card.appendChild(btn);
          grid.appendChild(card);
        });
      }

      let manualOverride = false;
      let overrideTimeout = null;

      function toggleDevice(index, state, isManual = false) {
        if (isManual) {
          manualOverride = true;
          updateControlMode();

          if (overrideTimeout) clearTimeout(overrideTimeout);

          overrideTimeout = setTimeout(() => {
            manualOverride = false;
            updateControlMode();
            addLogEntry("🔁 Kembali ke mode otomatis (jadwal)");
          }, 5 * 60 * 1000);
        }

        const device = devices[index];
        const newState = state !== undefined ? state : !device.state;
        client.publish(device.topicCtrl, state ? "1" : "0", { retain: true });

        if (isManual) {
          addLogEntry(
            `🖐️ ${device.name} ${state ? "dinyalakan" : "dimatikan"} secara manual`
          );
        }
        // Tidak langsung set state atau render, biarkan pesan MQTT yang mengatur
      }

      function updateControlMode() {
        const modeElement = document.getElementById("control-mode");
        if (manualOverride) {
          modeElement.textContent = "Manual";
          modeElement.style.color = "var(--off-state)";
        } else {
          modeElement.textContent = "Otomatis";
          modeElement.style.color = "var(--on-state)";
        }
      }

      function updateScheduleDisplay() {
        currentOnTime.textContent = jadwalGlobal.on || "--:--";
        currentOffTime.textContent = jadwalGlobal.off || "--:--";
        if (jadwalGlobal.on && jadwalGlobal.off) {
          scheduleStatus.textContent = "Aktif";
          scheduleStatus.style.color = "var(--on-state)";
        } else {
          scheduleStatus.textContent = "Tidak aktif";
          scheduleStatus.style.color = "var(--text-light)";
        }
      }

      function simpanJadwal() {
        const onTime = document.getElementById("global-on-time").value;
        const offTime = document.getElementById("global-off-time").value;

        if (!onTime || !offTime) {
          addLogEntry("❌ Waktu ON dan OFF wajib diisi!");
          return;
        }

        jadwalGlobal = { on: onTime, off: offTime };
        updateScheduleDisplay();

        // Simpan jadwal ke localStorage
        localStorage.setItem("jadwalGlobal", JSON.stringify(jadwalGlobal));

        // Kirim jadwal ke broker MQTT (dengan retain agar klien baru langsung mendapatkannya)
        client.publish(scheduleTopic, JSON.stringify(jadwalGlobal), {
          retain: true,
        });

        addLogEntry(`✅ Jadwal disimpan: Hidup ${onTime}, Mati ${offTime}`);
      }

      // MQTT Events
      client.on("connect", () => {
        addLogEntry("✅ Terhubung ke broker MQTT");

        // Subscribe semua topik kontrol lampu
        devices.forEach((device) => {
          client.subscribe(device.topicCtrl);
        });

        // Subscribe ke topik jadwal global
        client.subscribe(scheduleTopic);
        addLogEntry(
          `🔔 Mendengarkan pembaruan jadwal di topik: ${scheduleTopic}`
        );

        // Minta jadwal terbaru (jika ada) dengan mengirim pesan kosong
        client.publish(scheduleTopic + "/get", "");
      });

      client.on("error", (err) => {
        addLogEntry(`❌ Koneksi error: ${err.message}`);
      });

      client.on("message", (topic, message) => {
        const payload = message.toString();

        // Handle pesan untuk perangkat
        if (devices.some((d) => d.topicCtrl === topic)) {
          const index = devices.findIndex((d) => d.topicCtrl === topic);
          if (index !== -1) {
            const newState = payload === "1";
            if (devices[index].state !== newState) {
              devices[index].state = newState;
              renderDevices();
              addLogEntry(
                `${devices[index].name} ${
                  newState ? "Dinyalakan" : "Dimatikan"
                } (Sinkronisasi)`
              );
            }
          }
        }

        // Handle pesan untuk jadwal global
        if (topic === scheduleTopic) {
          try {
            const newSchedule = JSON.parse(payload);
            if (newSchedule.on && newSchedule.off) {
              jadwalGlobal = newSchedule;

              // Update UI
              document.getElementById("global-on-time").value = jadwalGlobal.on;
              document.getElementById("global-off-time").value =
                jadwalGlobal.off;
              updateScheduleDisplay();

              // Simpan ke localStorage
              localStorage.setItem(
                "jadwalGlobal",
                JSON.stringify(jadwalGlobal)
              );

              addLogEntry("📅 Jadwal global diperbarui dari broker");
            }
          } catch (e) {
            addLogEntry("❌ Error parsing jadwal dari broker");
          }
        }
      });

      // Cek jadwal di localStorage saat pertama kali load
      window.addEventListener("load", function () {
        const savedSchedule = localStorage.getItem("jadwalGlobal");
        if (savedSchedule) {
          try {
            jadwalGlobal = JSON.parse(savedSchedule);
            document.getElementById("global-on-time").value = jadwalGlobal.on;
            document.getElementById("global-off-time").value = jadwalGlobal.off;
            updateScheduleDisplay();
            addLogEntry("📅 Jadwal dimuat dari penyimpanan lokal");
          } catch (e) {
            addLogEntry("❌ Gagal memuat jadwal dari penyimpanan lokal");
          }
        }
      });

      setInterval(() => {
        if (!jadwalGlobal.on || !jadwalGlobal.off || manualOverride) return;

        const now = new Date();
        const jamMenit = now.toTimeString().substr(0, 5);

        if (jamMenit === jadwalGlobal.on) {
          devices.forEach((_, i) => toggleDevice(i, true));
          addLogEntry("⏰ Semua perangkat dinyalakan sesuai jadwal");
        }

        if (jamMenit === jadwalGlobal.off) {
          devices.forEach((_, i) => toggleDevice(i, false));
          addLogEntry("⏰ Semua perangkat dimatikan sesuai jadwal");
        }
      }, 1000);

      // Inisialisasi
      renderDevices();
      updateScheduleDisplay();
      addLogEntry("🔄 Sistem siap digunakan");
    </script>
  </body>
</html>
